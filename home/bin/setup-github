#!/usr/bin/env bash
set -Eeuo pipefail

set -a
# shellcheck disable=SC1090
source ~/ansi-colors.bash
set +a

force=false
org=true
while (($# > 0)); do
    case "$1" in
    -h | --help)
        echo "Create GitHub environment variables and Gradle properties.

$(y Usage:)
  $(g setup-github-env)

$(y Options:)
  $(g -f --force)  overwrite existing configuration
  $(g -h --help)   display this help and exit"
        exit 0
        ;;
    -f | --force)
        force=true
        ;;
    esac
    shift
done

file=~/.env.d/github.sh

if [[ -f "$file" ]]; then
    if [[ "$force" == false ]]; then
        echo -e "$(c "$file") exists; use the $(g --force)" >&2
        exit 1
    fi
fi

echo -n >"$file"
ask() {
    var=$1
    read "-r${2:-}p" "$var: " val
    [[ "$val" == '' ]] || echo "$var='$val'" >>"$file"
    echo "$val"
}
sask() { ask "$1" s; }

ask GITHUB_USER
sask GITHUB_TOKEN

if [[ "$org" == true ]] && org_name=$(ask GITHUB_ORG | tr 'a-z. -' 'A-Z_' | tr -cd 'A-Z0-9_'); then
    sask "${org_name}_GITHUB_TOKEN"
fi
