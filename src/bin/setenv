#!/usr/bin/env bash
set -Eeuo pipefail

usage() {
    cat <<USAGE
Create global environment variable.

Usage:
  setenv [option]â€¦ <name> <value>
  setenv -h | --help

Options:
  -f --force        overwrite existing environment variable
  -h --help         display this help and exit
  -i --interactive  ask if existing environment variable should be overwritten
  -n --no-fail      do not fail if environment variable exists
USAGE
}

force=false
interactive=false
fail=true

if (($# > 0)); then
    while :; do
        case "$1" in
        -f | --force)
            force=true
            ;;
        -h | --help)
            usage
            exit 0
            ;;
        -i | --interactive)
            interactive=true
            ;;
        -n | --no-fail)
            fail=false
            ;;
        *)
            break
            ;;
        esac
        shift
    done
fi

name=${1:?missing required environment variable name}
shift

if [[ ! "$name" =~ ^[A-Za-z0-9_]+$ ]]; then
    echo "Invalid environment variable name: $name"
    exit 1
fi

file="$HOME/dotfiles/env/$name"
if [[ -f "$file" && $force == false ]]; then
    if [[ $fail == false ]]; then
        exit 0
    fi

    if [[ $interactive == true ]]; then
        read -p "Delete existing env var $name? [yN] " -n 1 -r
        if [[ "$REPLY" != Y && "$REPLY" != y ]]; then
            exit 0
        fi
    else
        echo "Environment variable $name already exists." >&2
        usage >&2
        exit 1
    fi
fi

echo "$name=$*" >"$file"
